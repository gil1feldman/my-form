<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>住住拽转 注专 拽驻</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      direction: rtl;
      background-color: #f9f9f9;
    }
    header.topbar {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #eaeaea;
      padding: 4px 16px;
      box-sizing: border-box;
    }
    .logo {
      height: 50px;
    }
    .donate-button {
      background-color: #d32f2f;
      color: white;
      text-decoration: none;
      padding: 6px 10px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 0.95em;
    }
    .donate-button:hover {
      background-color: #b71c1c;
    }
    main {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      height: calc(100% - 60px);
      padding: 20px;
      box-sizing: border-box;
      max-width: 1000px;
      margin: auto;
    }
    h2 {
      margin: 0 0 10px 0;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    input, select, button {
      padding: 10px;
      font-size: 1em;
    }
    canvas {
      width: 100% !important;
      max-height: 35vh !important;
      margin-top: 15px;
    }
    #pageInfo {
      margin-top: 10px;
      font-size: 1.05em;
      text-align: right;
      line-height: 1.6;
    }
    #pageInfo b.label {
      color: #555;
      font-weight: bold;
    }
    #pageInfo ul {
      margin: 5px 0 0 0;
      padding-right: 20px;
    }
    #pageInfo li {
      margin-bottom: 6px;
    }
    a {
      margin-top: 8px;
      font-weight: bold;
      text-decoration: none;
    }
    .value {
      color: #0d47a1;
      font-weight: bold;
    }
  </style>
</head>
<body>
<header class="topbar">
  <div style="display: flex; gap: 10px;">
    <a href="https://beactive.co.il/project/80004" target="_blank" class="donate-button">转专  "爪 转"</a>
    <a href="https://gil1feldman.github.io/wiki_last_edits/" target="_blank" class="donate-button" style="background-color: #1976d2;"> 注专转 专转</a>
  </div>
  <img src="https://raw.githubusercontent.com/gil1feldman/my-form/main/logo_current_situation.png" alt=" " class="logo">
</header>
<main>
  <h2>转 注 注专 拽驻</h2>
  <div class="controls">
    <input type="text" id="pageTitle" placeholder=" 砖 注专">
    <select id="granularitySelect">
      <option value="daily" selected>专转 驻专 转</option>
      <option value="monthly">专转 驻专 砖转</option>
    </select>
    <select id="rangeSelect">
      <option value="7">7  专</option>
      <option value="30" selected>30  专</option>
      <option value="90">90  专</option>
      <option value="180">180  专</option>
      <option value="365">365  专</option>
      <option value="all"> 注</option>
    </select>
    <button onclick="loadData()">爪 转</button>
    <button onclick="downloadCSV()">专 CSV</button>
    <button id="generateLink" onclick="generateShareLink()" disabled>爪专 拽砖专 砖转祝</button>
  </div>

  <div id="wikiLink"></div>
  <div id="pageInfo"></div>

  <div id="viewsSummary" style="margin-top: 15px; font-weight: bold;"></div>
  <canvas id="viewsChart"></canvas>

  <div id="editsSummary" style="margin-top: 25px; font-weight: bold;"></div>
  <canvas id="editsChart"></canvas>
</main>
<script>
let viewsChart, editsChart;
let currentData = { title: '', dates: [], views: [], edits: [] };

async function loadData() {
  const title = document.getElementById("pageTitle").value.trim();
  const range = document.getElementById("rangeSelect").value;
  const granularity = document.getElementById("granularitySelect").value;
  if (!title) return;

  currentData.title = title;
  const encodedTitle = encodeURIComponent(title);
  const endDate = new Date();
  let startDate = new Date(endDate);
  if (range !== 'all') {
    startDate.setDate(endDate.getDate() - parseInt(range));
  } else {
    startDate = new Date("2015-07-01");
  }

  const formatAPI = d => d.toISOString().slice(0,10).replace(/-/g, '');
  const formatDisplay = d => new Date(d).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: '2-digit' });
  const startStr = formatAPI(startDate);
  const endStr = formatAPI(endDate);

  document.getElementById("pageInfo").innerText = "注 转...";
  document.getElementById("wikiLink").innerHTML = `<a href="https://he.wikipedia.org/wiki/${encodedTitle}" target="_blank">爪驻 注专 拽驻 禄</a>`;

  const viewsRes = await fetch(`https://wikimedia.org/api/rest_v1/metrics/pageviews/per-article/he.wikipedia.org/all-access/user/${encodedTitle}/daily/${startStr}/${endStr}`);
  const viewsData = await viewsRes.json();

  let dates = [], viewCounts = [];
  if (granularity === 'monthly') {
    const monthlyMap = {};
    for (const item of viewsData.items) {
      const key = item.timestamp.slice(0,6);
      monthlyMap[key] = (monthlyMap[key] || 0) + item.views;
    }
    dates = Object.keys(monthlyMap).map(k => `${k.slice(4, 6)}/${k.slice(0, 4)}`);
    viewCounts = Object.values(monthlyMap);
  } else {
    const rawDates = viewsData.items.map(i => i.timestamp.slice(0,8));
    dates = rawDates.map(d => formatDisplay(`${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}`));
    viewCounts = viewsData.items.map(i => i.views);
  }

  currentData.dates = dates;
  currentData.views = viewCounts;
  document.getElementById("viewsSummary").innerHTML =
    `住  爪驻转 转拽驻 砖 <span class="value">${dates[0]}</span> 注 <span class="value">${dates[dates.length - 1]}</span>: <span class="value">${viewCounts.reduce((a, b) => a + b, 0).toLocaleString()}</span>`;

  if (viewsChart) viewsChart.destroy();
  viewsChart = new Chart(document.getElementById("viewsChart"), {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: '爪驻转 转',
        data: viewCounts,
        borderColor: 'blue',
        fill: false
      }]
    },
    options: {
      scales: { y: { beginAtZero: true } },
      plugins: { datalabels: { display: false }, legend: { display: false } }
    },
    plugins: [ChartDataLabels]
  });

  const editMap = {};
  let continueToken = null;
  let done = false;
  while (!done) {
    let url = `https://he.wikipedia.org/w/api.php?action=query&format=json&prop=revisions&titles=${encodedTitle}&rvlimit=max&rvstart=${endDate.toISOString()}&rvend=${startDate.toISOString()}&rvprop=timestamp&origin=*`;
    if (continueToken) url += `&rvcontinue=${continueToken}`;
    const res = await fetch(url);
    const data = await res.json();
    const revisions = Object.values(data.query.pages)[0]?.revisions || [];
    for (const rev of revisions) {
      let d = new Date(rev.timestamp);
      let key = granularity === 'monthly' ? `${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}` : d.toLocaleDateString('he-IL');
      editMap[key] = (editMap[key] || 0) + 1;
    }
    if (data.continue?.rvcontinue) continueToken = data.continue.rvcontinue;
    else done = true;
  }

  const editsCounts = dates.map(d => editMap[d] || 0);
  currentData.edits = editsCounts;
  document.getElementById("editsSummary").innerHTML =
    `住  注专转 转拽驻  <span class="value">${dates[0]}</span> 注 <span class="value">${dates[dates.length - 1]}</span>: <span class="value">${editsCounts.reduce((a, b) => a + b, 0).toLocaleString()}</span>`;

  if (editsChart) editsChart.destroy();
  editsChart = new Chart(document.getElementById("editsChart"), {
    type: 'bar',
    data: {
      labels: dates,
      datasets: [{
        label: '住驻专 注专转',
        data: editsCounts,
        backgroundColor: 'orange'
      }]
    },
    options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
  });

  const createdRes = await fetch(`https://he.wikipedia.org/w/api.php?action=query&format=json&prop=revisions&titles=${encodedTitle}&rvlimit=1&rvdir=newer&rvprop=timestamp|user&origin=*`);
  const createdData = await createdRes.json();
  const page = Object.values(createdData.query.pages)[0];
  if (page.missing) {
    document.getElementById("pageInfo").innerHTML = `<span style="color: red;"><b>砖:</b> 注专 "<span class="value">${title}</span>"  爪 拽驻.</span>`;
    if (viewsChart) viewsChart.destroy();
    if (editsChart) editsChart.destroy();
    return;
  }

  const created = page.revisions?.[0];
  const createdText = created ? `<span><b class="label">祝 爪专 注 </b> <span class="value">${created.user}</span> <b class="label">转专</b> <span class="value">${new Date(created.timestamp).toLocaleString('he-IL')}</span></span><br>` : '';

  const lastRes = await fetch(`https://he.wikipedia.org/w/api.php?action=query&format=json&prop=revisions&titles=${encodedTitle}&rvlimit=1&rvprop=timestamp|user&origin=*`);
  const lastData = await lastRes.json();
  const lastEdit = Object.values(lastData.query.pages)[0].revisions?.[0];

  let warning = '';
  if (lastEdit) {
    const editTime = new Date(lastEdit.timestamp);
    const now = new Date();
    const diffMinutes = Math.floor((now - editTime) / (1000 * 60));
    const hours = Math.floor(diffMinutes / 60);
    const minutes = diffMinutes % 60;
    if (hours < 5) {
      const timeText = hours > 0 ? `${hours} 砖注转 -${minutes} 拽转` : `${minutes} 拽转`;
      warning = ` <span style="color: red;">( 砖 , 注专 专 爪注 驻 ${timeText})</span>`;
    }
  }

  const lastText = lastEdit ? `<span><b class="label">注专 专 爪注 注 </b> <span class="value">${lastEdit.user}</span> <b class="label">转专</b> <span class="value">${new Date(lastEdit.timestamp).toLocaleString('he-IL')}</span></span>${warning}` : '';
  document.getElementById("pageInfo").innerHTML = createdText + lastText;
  document.getElementById("generateLink").disabled = false;
}

function downloadCSV() {
  if (!currentData.dates.length) {
    alert(" 转 专.");
    return;
  }
  let csv = '转专,爪驻转,注专转\n';
  for (let i = 0; i < currentData.dates.length; i++) {
    csv += `${currentData.dates[i]},${currentData.views[i]},${currentData.edits[i]}\n`;
  }
  const bom = '\uFEFF';
  const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `wiki_${currentData.title}_stats.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function generateShareLink() {
  const title = currentData.title;
  if (!title) return;
  const baseUrl = window.location.origin + window.location.pathname;
  const fullUrl = `${baseUrl}?pageTitle=${encodeURIComponent(title)}`;
  navigator.clipboard.writeText(fullUrl).then(() => {
    alert(" 拽砖专 注转拽 ! 转 拽 住驻   拽 砖转专爪.");
  }).catch(() => {
    alert("砖 注转拽. 住 注转拽 转 拽砖专 转:\n" + fullUrl);
  });
}

window.addEventListener("load", () => {
  const params = new URLSearchParams(window.location.search);
  const pageTitle = params.get("pageTitle");
  if (pageTitle) {
    document.getElementById("pageTitle").value = decodeURIComponent(pageTitle);
    loadData();
  }
});
</script>
</body>
</html>
